<% content_for :title, "Calorie Tracker" %>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="margin: 0;">üçî Calorie Tracker</h1>
    <%= link_to "‚ûï Add Item", new_user_meal_path, method: :get, class: "btn btn-primary" %>
    <% total_logged_calories = 0 %>
  </div>

  <% if @user_meals.any? %>
    <h3 style="margin-top: 0;">Logged Meals for <%= Date.today.strftime("%B %d, %Y") %></h3>
    <!-- Recipes Section -->
    <div class="to-buy-section" style="background: linear-gradient(135deg, rgba(255,230,109,0.2) 0%, rgba(255,230,109,0.05) 100%); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 2rem;">
      <% total_recipe_calories = 0 %>
      <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">Recipes</h2>
      <% if @user_meals.any? && @user_meals.any? { |m| m.recipe.present? && m.recipe.recipe_ingredients.any? } %>
        <table>
          <thead>
            <tr>
              <th>Recipe</th>
              <th>Quantity</th>
              <th>Ingredients</th>
              <th>Calories</th>
              <th style="text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @user_meals.each do |meal| %>
              <% if meal.recipe.present? && meal.recipe.recipe_ingredients.any? %>
                <% total_recipe_calories += meal.total_calories %>
                <tr>
                  <td><strong style="font-size: 1.1rem;"><%= meal.recipe.name %></strong></td>
                  <td>
                    <span style="background: var(--success); padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-weight: 600;">
                      <%= meal.servings %>
                    </span>
                  </td>
                  <td><%= meal.recipe.recipe_ingredients.map { |ri| ri.ingredient.name }.join(", ") %></td>
                  <td><%= meal.total_calories %> cal</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                      <%= button_to "üóëÔ∏è Delete", user_meal_path(meal), method: :delete, data: { confirm: "Remove this meal?" }, class: "btn btn-sm btn-danger" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>

        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem;">
          <strong style="font-size: 1.1rem;">Total Calories:</strong>
          <span style="background: var(--accent); color: var(--text-dark); padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 1rem; font-weight: 700;">
            <%= total_recipe_calories %> cal
          </span>
        </div>
      <% else %>
        <div class="empty-state">
          <div class="empty-state-icon">üéâ</div>
          <p>No logged recipes yet. Start by adding a new recipe!</p>
        </div>
      <% end %>
    </div>

    <!-- Individual Ingredients Section -->
    <div class="to-buy-section" style="background: linear-gradient(135deg, rgba(149,225,211,0.2) 0%, rgba(149,225,211,0.05) 100%); padding: 1.5rem; border-radius: var(--radius-md);">
      <% total_custom_calories = 0 %>
      <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
        Individual Ingredients
      </h2>
      <% if @user_meals.any? && @user_meals.any? { |m| m.user_meal_ingredients.any? } %>
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Calories Per Unit</th>
              <th>Total Calories</th>
              <th style="text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @user_meals.each do |meal| %>
              <% meal.user_meal_ingredients.each do |umi| %>
                <% total_custom_calories += umi.quantity * umi.ingredient.calories_per_unit %>
                <tr>
                  <td><strong style="font-size: 1.1rem;"><%= umi.ingredient.name %></strong></td>
                  <td>
                    <span style="background: var(--success); padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-weight: 600;">
                      <%= umi.quantity %>
                    </span>
                  </td>
                  <td><%= umi.ingredient.calories_per_unit %> cal</td>
                  <td><%= umi.quantity * umi.ingredient.calories_per_unit %> cal</td>
                  <td style="text-align: center;">
                    <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                      <%= button_to "üóëÔ∏è Delete", user_meal_user_meal_ingredient_path(meal, umi), method: :delete, data: { confirm: "Remove this ingredient?" }, class: "btn btn-sm btn-danger" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>

        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem;">
          <strong style="font-size: 1.1rem;">Total Calories:</strong>
          <span style="background: var(--success); color: var(--text-dark); padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 1rem; font-weight: 700;">
            <%= total_custom_calories %> cal
          </span>
        </div>

      <% else %>
        <div class="empty-state">
          <div class="empty-state-icon">üõí</div>
          <p>No logged ingredients yet. Start by adding a new ingredient!</p>
        </div>
      <% end %>
    </div>

    <div>
      <% total_logged_calories = total_recipe_calories + total_custom_calories %>
      <h2 style="margin-top: 2rem; text-align: center; color: var(--text-dark);">
        Total Calories Today: 
        <span style="background: var(--primary); color: var(--text-dark); padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 1.2rem; font-weight: 700;">
          <%= total_logged_calories %> cal
        </span>
      </h2>
    </div>
    
  <% else %>
    <p style="color: var(--text-muted);">You haven't logged any meals yet. Start by adding a new meal!</p>
  <% end %>
</div>

<div style="display: flex; justify-content: center; text-align: center; gap: 10px; margin-top: 2rem;">
  <%= button_to "Clear All Meals", clear_all_user_meals_path, method: :delete, data: { confirm: "Are you sure you want to delete all meals?" }, class: "btn btn-danger" %>
  <%= link_to "‚Üê Back to Home", root_path, class: "btn btn-secondary" %>
</div>
