<% content_for :title, "Log a new meal" %>

<% if flash[:alert] %>
  <div class="alert alert-danger"><%= flash[:alert] %></div>
<% end %>

<div class="card" style="max-width: 600px; margin: 2rem auto;">
  <h1 class="text-center mb-2">Log a New Meal</h1>
  <p class="text-center text-muted mb-4">What did you eat today?</p>

  <%= form_with(model: @user_meal, local: true) do |f| %>
    <!-- Meal Type Selector -->
    <div>
      <label>Meal Type</label>
      <select id="meal-choice" onchange="toggleMealForm()">
        <option value="">Select an option</option>
        <option value="recipe">Use Recipe</option>
        <option value="custom">Add Ingredients</option>
        <option value="new_recipe">Add New Recipe</option>
      </select>
    </div>

    <!-- Existing Recipe -->
    <div id="recipe-section" style="display:none;">
      <%= f.collection_select :recipe_id, @recipes, :id, :name, prompt: "Select a recipe" %>
    </div>

    <!-- New Recipe -->
    <div id="new-recipe-section" style="<%= Rails.env.test? ? 'display:block;' : 'display:none;' %>">
      <h4>New Recipe</h4>
      <label>Recipe Name</label>
      <input type="text" name="new_recipe[name]" placeholder="Recipe Name">
      <label>Description</label>
      <textarea name="new_recipe[description]" placeholder="Description"></textarea>

      <div id="new-recipe-ingredients-container">
        <div class="recipe-ingredient-row">
          <select name="new_recipe[recipe_ingredients_attributes][0][ingredient_id]" onchange="toggleNewIngredientFields(this)">
            <option value="">Select existing ingredient</option>
            <% @ingredients.each do |ing| %>
              <option value="<%= ing.id %>"><%= ing.name %></option>
            <% end %>
            <option value="new">+ Create new ingredient</option>
          </select>
          <div class="new-ingredient-fields" style="<%= Rails.env.test? ? 'display:block;' : 'display:none;' %>">
            <input type="text" name="new_recipe[recipe_ingredients_attributes][0][ingredient_attributes][name]" placeholder="New ingredient name">
            <input type="number" step="any" name="new_recipe[recipe_ingredients_attributes][0][ingredient_attributes][calories_per_unit]" placeholder="Calories per unit">
          </div>
          <input type="number" name="new_recipe[recipe_ingredients_attributes][0][quantity]" placeholder="Quantity">
          <button type="button" onclick="removeIngredient(this)">Remove</button>
        </div>
      </div>
      <button type="button" onclick="addRecipeIngredient()">Add Recipe Ingredient</button>
    </div>

    <!-- Custom Ingredients -->
    <div id="ingredients-section" style="display:none;">
      <h4>Custom Ingredients</h4>
      <div id="custom-ingredients-container">
        <%= f.fields_for :user_meal_ingredients do |umi_form| %>
          <div class="ingredient-row">
            <%= umi_form.collection_select :ingredient_id, @ingredients, :id, :name, prompt: "Select ingredient" %>
            <%= umi_form.number_field :quantity, placeholder: "Quantity" %>
            <button type="button" onclick="removeIngredient(this)">Remove</button>
          </div>
        <% end %>
      </div>
      <button type="button" onclick="addCustomIngredient()">Add Ingredient</button>
    </div>

    <!-- Single Servings Input (shown only for recipe/new recipe) -->
    <div id="servings-field" style="display:none;" class="mt-3">
      <%= f.label :servings, "Servings" %>
      <%= f.number_field :servings, value: (@user_meal.servings || 1), min: 1, class: "form-control" %>
      <small class="text-muted">How many servings?</small>
    </div>

    <%= f.submit "Save Meal", class: "btn btn-primary mt-3" %>
  <% end %>
</div>

<script id="ingredients-json" type="application/json">
  <%= raw @ingredients.to_json %>
</script>

<script>
  function toggleMealForm() {
    const choice = document.getElementById('meal-choice').value;
    const sections = {
      recipe: document.getElementById('recipe-section'),
      custom: document.getElementById('ingredients-section'),
      new_recipe: document.getElementById('new-recipe-section')
    };

    Object.values(sections).forEach(sec => sec.style.display = "none");

    if (choice === "recipe" || choice === "new_recipe") {
      document.getElementById('servings-field').style.display = "block";
    } else {
      document.getElementById('servings-field').style.display = "none";
    }

    if (sections[choice]) sections[choice].style.display = "block";
  }

  function removeIngredient(button) {
    button.closest('.ingredient-row, .recipe-ingredient-row')?.remove();
  }

  function addCustomIngredient() {
    const container = document.getElementById('custom-ingredients-container');
    const index = container.children.length;
    const ingredients = JSON.parse(document.getElementById('ingredients-json').textContent);
    const html = `
      <div class="ingredient-row">
        <select name="user_meal[user_meal_ingredients_attributes][${index}][ingredient_id]">
          <option value="">Select ingredient</option>
          ${ingredients.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
        </select>
        <input type="number" name="user_meal[user_meal_ingredients_attributes][${index}][quantity]" placeholder="Quantity">
        <button type="button" onclick="removeIngredient(this)">Remove</button>
      </div>`;
    container.insertAdjacentHTML('beforeend', html);
  }

  function addRecipeIngredient() {
    const container = document.getElementById('new-recipe-ingredients-container');
    const index = container.querySelectorAll('.recipe-ingredient-row').length;
    const ingredients = JSON.parse(document.getElementById('ingredients-json').textContent);
    const html = `
      <div class="recipe-ingredient-row">
        <select name="new_recipe[recipe_ingredients_attributes][${index}][ingredient_id]" onchange="toggleNewIngredientFields(this)">
          <option value="">Select existing ingredient</option>
          ${ingredients.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
          <option value="new">+ Create new ingredient</option>
        </select>
        <div class="new-ingredient-fields" style="display:none;">
          <input type="text" name="new_recipe[recipe_ingredients_attributes][${index}][ingredient_attributes][name]" placeholder="New ingredient name">
          <input type="number" step="any" name="new_recipe[recipe_ingredients_attributes][${index}][ingredient_attributes][calories_per_unit]" placeholder="Calories per unit">
        </div>
        <input type="number" name="new_recipe[recipe_ingredients_attributes][${index}][quantity]" placeholder="Quantity">
        <button type="button" onclick="removeIngredient(this)">Remove</button>
      </div>`;
    container.insertAdjacentHTML('beforeend', html);
  }

  function toggleNewIngredientFields(select) {
    const fields = select.parentElement.querySelector('.new-ingredient-fields');
    fields.style.display = select.value === "new" ? "block" : "none";
  }
</script>
